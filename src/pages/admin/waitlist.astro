---
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;
---

<BaseLayout
  title="toyb | Admin Waitlist"
  description="Internal waitlist manager."
  canonical="https://toyb.space/admin/waitlist"
  robots="noindex,nofollow"
>
  <section class="section" data-reveal>
    <div class="section__head">
      <h1>Waitlist</h1>
      <p>Filter members, invite beta, and toggle beta active.</p>
    </div>

    <div class="admin-auth">
      <label class="sr-only" for="admin-token-input">Admin token</label>
      <input id="admin-token-input" type="password" placeholder="Admin token" />
      <button class="button button-primary" id="admin-token-save" type="button">
        Authenticate
      </button>
      <button class="button" id="admin-token-clear" type="button">Logout</button>
    </div>

    <form id="waitlist-filters" class="filters" autocomplete="off">
      <label>
        Marketing
        <select name="marketing">
          <option value="">All</option>
          <option value="true">Only opt-in</option>
          <option value="false">Only opt-out</option>
        </select>
      </label>
      <label>
        Source
        <input name="source" type="text" placeholder="landing" />
      </label>
      <label>
        Beta
        <select name="beta">
          <option value="">All</option>
          <option value="invited">Invited</option>
          <option value="active">Active</option>
          <option value="none">None</option>
        </select>
      </label>
      <label>
        Subscribed only
        <input name="subscribed_only" type="checkbox" checked />
      </label>
      <button class="button" type="submit">Apply filters</button>
    </form>

    <p class="admin-feedback" id="admin-feedback" aria-live="polite"></p>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Created</th>
            <th>Source</th>
            <th>Marketing</th>
            <th>Unsubscribed</th>
            <th>Beta invited</th>
            <th>Beta active</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="waitlist-body"></tbody>
      </table>
    </div>

    <div class="pager">
      <button class="button" id="prev-page" type="button">Prev</button>
      <p id="pager-info">Page 1</p>
      <button class="button" id="next-page" type="button">Next</button>
    </div>
  </section>

  <script>
    // @ts-nocheck
    import { track } from "../../lib/analytics";
    import {
      adminFetch,
      clearAdminToken,
      getAdminToken,
      setAdminToken,
    } from "../../lib/admin-client";

    const tokenInput = document.getElementById("admin-token-input");
    const saveButton = document.getElementById("admin-token-save");
    const clearButton = document.getElementById("admin-token-clear");
    const filtersForm = document.getElementById("waitlist-filters");
    const feedback = document.getElementById("admin-feedback");
    const bodyEl = document.getElementById("waitlist-body");
    const pagerInfo = document.getElementById("pager-info");
    const prevPage = document.getElementById("prev-page");
    const nextPage = document.getElementById("next-page");

    let offset = 0;
    const limit = 25;
    let totalCount = 0;

    const setFeedback = (message) => {
      if (feedback) feedback.textContent = message;
    };

    const rowMarkup = (row) => {
      const invited = row.beta_invited_at ? "yes" : "no";
      const unsubscribed = row.unsubscribed_at ? "yes" : "no";
      const marketing = row.marketing_consent ? "yes" : "no";
      return `
        <tr>
          <td>${row.email}</td>
          <td>${new Date(row.created_at).toLocaleString()}</td>
          <td>${row.source ?? "-"}</td>
          <td>${marketing}</td>
          <td>${unsubscribed}</td>
          <td>${invited}</td>
          <td>
            <label>
              <input
                type="checkbox"
                data-action="toggle-active"
                data-email="${row.email}"
                ${row.beta_active ? "checked" : ""}
              />
            </label>
          </td>
          <td>
            <button class="button" type="button" data-action="invite" data-email="${row.email}">
              Invite beta
            </button>
          </td>
        </tr>
      `;
    };

    const getQuery = () => {
      if (!(filtersForm instanceof HTMLFormElement)) return new URLSearchParams();
      const form = new FormData(filtersForm);
      const query = new URLSearchParams();
      const marketing = (form.get("marketing") ?? "").toString();
      const source = (form.get("source") ?? "").toString().trim();
      const beta = (form.get("beta") ?? "").toString();
      const subscribedOnly = form.get("subscribed_only") === "on";

      if (marketing) query.set("marketing", marketing);
      if (source) query.set("source", source);
      if (beta) query.set("beta", beta);
      query.set("subscribed_only", String(subscribedOnly));
      query.set("limit", String(limit));
      query.set("offset", String(offset));
      return query;
    };

    const renderPager = () => {
      const page = Math.floor(offset / limit) + 1;
      const pages = Math.max(Math.ceil(totalCount / limit), 1);
      if (pagerInfo) pagerInfo.textContent = `Page ${page} / ${pages}`;
      if (prevPage instanceof HTMLButtonElement) prevPage.disabled = offset <= 0;
      if (nextPage instanceof HTMLButtonElement)
        nextPage.disabled = offset + limit >= totalCount;
    };

    const loadRows = async () => {
      const query = getQuery();
      const { response, body } = await adminFetch(`/api/admin/waitlist?${query.toString()}`);

      if (!response.ok) {
        if (response.status === 401 || response.status === 403) {
          setFeedback("Authentication required or invalid token.");
          if (bodyEl) bodyEl.innerHTML = "";
          return;
        }
        setFeedback("Unable to load waitlist.");
        return;
      }

      const rows = Array.isArray(body?.rows) ? body.rows : [];
      totalCount = Number(body?.total_count ?? 0);

      if (bodyEl) {
        bodyEl.innerHTML = rows.map((row) => rowMarkup(row)).join("");
      }
      renderPager();
      setFeedback(`Loaded ${rows.length} rows.`);
    };

    const inviteEmail = async (email) => {
      const { response } = await adminFetch("/api/admin/beta/invite", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ emails: [email] }),
      });

      if (!response.ok) {
        setFeedback("Invite failed.");
        return;
      }

      setFeedback(`Beta invite updated for ${email}.`);
      loadRows();
    };

    const setActive = async (email, active) => {
      const { response } = await adminFetch("/api/admin/beta/set-active", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ email, active }),
      });

      if (!response.ok) {
        setFeedback("Update failed.");
        return;
      }

      setFeedback(`Beta active updated for ${email}.`);
      loadRows();
    };

    bodyEl?.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.dataset.action !== "invite") return;
      const email = target.dataset.email;
      if (!email) return;
      inviteEmail(email);
    });

    bodyEl?.addEventListener("change", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement)) return;
      if (target.dataset.action !== "toggle-active") return;
      const email = target.dataset.email;
      if (!email) return;
      setActive(email, target.checked);
    });

    filtersForm?.addEventListener("submit", (event) => {
      event.preventDefault();
      offset = 0;
      loadRows();
    });

    prevPage?.addEventListener("click", () => {
      offset = Math.max(offset - limit, 0);
      loadRows();
    });

    nextPage?.addEventListener("click", () => {
      if (offset + limit >= totalCount) return;
      offset += limit;
      loadRows();
    });

    saveButton?.addEventListener("click", () => {
      if (!(tokenInput instanceof HTMLInputElement)) return;
      const token = tokenInput.value.trim();
      if (!token) {
        setFeedback("Insert admin token.");
        return;
      }
      setAdminToken(token);
      tokenInput.value = "";
      loadRows();
    });

    clearButton?.addEventListener("click", () => {
      clearAdminToken();
      setFeedback("Logged out.");
      if (bodyEl) bodyEl.innerHTML = "";
    });

    if (getAdminToken()) {
      loadRows();
    } else {
      setFeedback("Insert admin token to load data.");
      renderPager();
    }

    track("admin_waitlist_view", { path: window.location.pathname });
  </script>

  <style>
    .admin-auth,
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.7rem;
      margin-block: 1rem;
      align-items: end;
    }

    .admin-auth input,
    .filters input,
    .filters select {
      width: 100%;
      border-radius: 0.85rem;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 0.62rem 0.75rem;
    }

    .filters label {
      font-size: var(--text-sm);
      color: var(--muted);
      display: grid;
      gap: 0.35rem;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: color-mix(in srgb, var(--surface) 84%, transparent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 920px;
    }

    th,
    td {
      text-align: left;
      border-bottom: 1px solid var(--border);
      padding: 0.55rem 0.6rem;
      font-size: var(--text-sm);
    }

    .pager {
      margin-top: 1rem;
      display: flex;
      gap: 0.7rem;
      align-items: center;
    }

    .admin-feedback {
      min-height: 1.2rem;
      margin-block: 0.5rem;
    }
  </style>
</BaseLayout>
