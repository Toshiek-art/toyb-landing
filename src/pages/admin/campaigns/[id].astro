---
import BaseLayout from "../../../layouts/BaseLayout.astro";

export const prerender = false;
const campaignId = Astro.params.id ?? "";
---

<BaseLayout
  title="toyb | Campaign Detail"
  description="Internal campaign detail."
  canonical={`https://toyb.space/admin/campaigns/${campaignId}`}
  robots="noindex,nofollow"
>
  <section class="section" data-reveal>
    <div class="section__head">
      <h1>Campaign Detail</h1>
      <p>
        Campaign ID: <code id="campaign-id" data-campaign-id={campaignId}
          >{campaignId}</code
        >
      </p>
    </div>

    <div class="admin-auth">
      <label class="sr-only" for="admin-token-input">Admin token</label>
      <input id="admin-token-input" type="password" placeholder="Admin token" />
      <button class="button button-primary" id="admin-token-save" type="button">
        Authenticate
      </button>
      <button class="button" id="admin-token-clear" type="button">Logout</button>
    </div>

    <p class="admin-feedback" id="admin-feedback" aria-live="polite"></p>

    <article class="admin-card">
      <h2>Meta</h2>
      <pre id="campaign-meta">Loading...</pre>
    </article>

    <article class="admin-card">
      <h2>Recipients</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Status</th>
              <th>Sent at</th>
              <th>Error code</th>
            </tr>
          </thead>
          <tbody id="recipients-body"></tbody>
        </table>
      </div>
      <div class="pager">
        <button class="button" id="prev-page" type="button">Prev</button>
        <p id="pager-info">Page 1</p>
        <button class="button" id="next-page" type="button">Next</button>
      </div>
    </article>
  </section>

  <script>
    // @ts-nocheck
    import {
      adminFetch,
      clearAdminToken,
      getAdminToken,
      setAdminToken,
    } from "../../../lib/admin-client";

    const campaignId =
      document
        .getElementById("campaign-id")
        ?.getAttribute("data-campaign-id")
        ?.trim() ?? "";

    const tokenInput = document.getElementById("admin-token-input");
    const saveButton = document.getElementById("admin-token-save");
    const clearButton = document.getElementById("admin-token-clear");
    const feedback = document.getElementById("admin-feedback");
    const meta = document.getElementById("campaign-meta");
    const bodyEl = document.getElementById("recipients-body");
    const prevPage = document.getElementById("prev-page");
    const nextPage = document.getElementById("next-page");
    const pagerInfo = document.getElementById("pager-info");

    let offset = 0;
    const limit = 100;
    let totalCount = 0;

    const setFeedback = (message) => {
      if (feedback) feedback.textContent = message;
    };

    const renderPager = () => {
      const page = Math.floor(offset / limit) + 1;
      const pages = Math.max(Math.ceil(totalCount / limit), 1);
      if (pagerInfo) pagerInfo.textContent = `Page ${page} / ${pages}`;
      if (prevPage instanceof HTMLButtonElement) prevPage.disabled = offset <= 0;
      if (nextPage instanceof HTMLButtonElement)
        nextPage.disabled = offset + limit >= totalCount;
    };

    const loadCampaign = async () => {
      const { response, body } = await adminFetch(`/api/admin/campaigns/${campaignId}`);
      if (!response.ok) {
        setFeedback("Unable to load campaign detail.");
        return false;
      }

      if (meta) {
        meta.textContent = JSON.stringify(body?.campaign ?? {}, null, 2);
      }
      return true;
    };

    const loadRecipients = async () => {
      const params = new URLSearchParams({
        limit: String(limit),
        offset: String(offset),
      });
      const { response, body } = await adminFetch(
        `/api/admin/campaigns/${campaignId}/recipients?${params.toString()}`,
      );

      if (!response.ok) {
        setFeedback("Unable to load recipients.");
        return;
      }

      const rows = Array.isArray(body?.rows) ? body.rows : [];
      totalCount = Number(body?.total_count ?? 0);

      if (bodyEl) {
        bodyEl.innerHTML = rows
          .map(
            (row) => `
              <tr>
                <td>${row.email}</td>
                <td>${row.status}</td>
                <td>${row.sent_at ? new Date(row.sent_at).toLocaleString() : "-"}</td>
                <td>${row.error_code ?? "-"}</td>
              </tr>
            `,
          )
          .join("");
      }
      renderPager();
      setFeedback(`Loaded ${rows.length} recipients.`);
    };

    const loadAll = async () => {
      const ok = await loadCampaign();
      if (!ok) return;
      await loadRecipients();
    };

    prevPage?.addEventListener("click", () => {
      offset = Math.max(offset - limit, 0);
      loadRecipients();
    });

    nextPage?.addEventListener("click", () => {
      if (offset + limit >= totalCount) return;
      offset += limit;
      loadRecipients();
    });

    saveButton?.addEventListener("click", () => {
      if (!(tokenInput instanceof HTMLInputElement)) return;
      const token = tokenInput.value.trim();
      if (!token) {
        setFeedback("Insert admin token.");
        return;
      }
      setAdminToken(token);
      tokenInput.value = "";
      loadAll();
    });

    clearButton?.addEventListener("click", () => {
      clearAdminToken();
      setFeedback("Logged out.");
      if (meta) meta.textContent = "No data.";
      if (bodyEl) bodyEl.innerHTML = "";
    });

    if (getAdminToken()) {
      loadAll();
    } else {
      setFeedback("Insert admin token to load campaign data.");
      renderPager();
    }
  </script>

  <style>
    .admin-auth {
      display: grid;
      grid-template-columns: minmax(220px, 1fr) auto auto;
      gap: 0.7rem;
      margin-block: 1rem;
    }

    .admin-auth input {
      border-radius: 0.85rem;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 0.62rem 0.75rem;
    }

    .admin-card {
      margin-top: 0.8rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0.95rem;
      background: color-mix(in srgb, var(--surface) 84%, transparent);
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      border-radius: var(--radius-sm);
      padding: 0.65rem;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 84%, transparent);
      min-height: 80px;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: color-mix(in srgb, var(--surface) 84%, transparent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    th,
    td {
      text-align: left;
      border-bottom: 1px solid var(--border);
      padding: 0.55rem 0.6rem;
      font-size: var(--text-sm);
    }

    .pager {
      margin-top: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.65rem;
    }

    .admin-feedback {
      min-height: 1.2rem;
    }

    @media (max-width: 840px) {
      .admin-auth {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
