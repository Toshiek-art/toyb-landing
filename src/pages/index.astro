---
import FeatureGrid from "../components/FeatureGrid.astro";
import Hero from "../components/Hero.astro";
import Section from "../components/Section.astro";
import { getPrivacyHref, PRIVACY_VERSION } from "../lib/privacy";
import BaseLayout from "../layouts/BaseLayout.astro";

export const prerender = true;
const waitlistTurnstileEnabled =
  import.meta.env.WAITLIST_TURNSTILE_ENABLED === "true";
const turnstileSiteKey = import.meta.env.TURNSTILE_SITE_KEY ?? "";
const privacyHref = getPrivacyHref();

const whyItems = [
  {
    title: "Projects as universes",
    text: "Model creative work as interconnected systems instead of isolated files and folders.",
  },
  {
    title: "Narrative graph & timeline",
    text: "Track relationships, chronology, and dependencies without losing clarity.",
  },
  {
    title: "AI-assisted coherence checks",
    text: "Surface contradictions early while preserving author intent and stylistic control.",
  },
];

const creatorBullets = [
  "Structure lore, scenes, and entities in one deliberate workspace.",
  "Use modular building blocks for worlds that evolve over time.",
  "Keep constraints visible so creativity scales without chaos.",
];
---

<BaseLayout
  title="toyb | Build universes. Break complexity."
  description="Toyb is a modular worldbuilding engine for creators who think in systems."
  canonical="https://toyb.space/"
>
  <Hero />

  <section class="founder-note" aria-label="Founder note" data-reveal>
    <p class="founder-note__text">
      Toyb was built out of frustration with tools that treat worlds like
      folders. I wanted something that thinks in systems. If you build in
      systems too, you'll feel at home here.
    </p>
  </section>

  <section class="waitlist" aria-labelledby="waitlist-title" data-reveal>
    <h2 id="waitlist-title">Join the first system builders.</h2>
    <p class="waitlist__sub">
      Early members get direct access, private feedback channel, and lifetime
      beta perks.
    </p>
    <form
      class="waitlist__form"
      data-waitlist-form
      data-privacy-version={PRIVACY_VERSION}
    >
      <div class="waitlist__row">
        <label class="sr-only" for="waitlist-email">Email address</label>
        <input
          id="waitlist-email"
          class="waitlist__input"
          name="email"
          type="email"
          autocomplete="email"
          placeholder="Your email"
          required
        />
        <button class="button button-primary waitlist__button" type="submit">
          Request early access
        </button>
      </div>
      <div class="waitlist__honeypot" aria-hidden="true">
        <label for="waitlist-company">Company</label>
        <input
          id="waitlist-company"
          name="company"
          type="text"
          tabindex="-1"
          autocomplete="off"
        />
      </div>
      <div class="waitlist__consents">
        <label class="waitlist__consent">
          <input
            class="waitlist__checkbox"
            name="age_privacy_confirmed"
            type="checkbox"
            required
          />
          <span>
            I declare I am at least 16 years old.{" "}
            <a href={privacyHref} data-privacy-version={PRIVACY_VERSION}
              >Privacy policy</a
            >.
          </span>
        </label>
        <label class="waitlist__consent">
          <input
            class="waitlist__checkbox"
            name="marketing_consent"
            type="checkbox"
          />
          <span>
            I consent to receive promotional emails and launch updates
            (newsletter).
          </span>
        </label>
      </div>
      {
        waitlistTurnstileEnabled && (
          <div class="waitlist__turnstile">
            <div class="cf-turnstile" data-sitekey={turnstileSiteKey} />
          </div>
        )
      }
    </form>
    <p class="waitlist__feedback" aria-live="polite" data-waitlist-feedback></p>
  </section>

  <Section
    id="why-toyb"
    title="Why Toyb"
    subtitle="A calm interface for complex creative systems. Minimal surface, maximum control."
  >
    <FeatureGrid items={whyItems} />
  </Section>

  <Section
    id="creators"
    title="Built for creators"
    subtitle="For writers, worldbuilders, design leads, and narrative teams shipping coherent universes."
  >
    <div class="creators-grid">
      <ul class="bullets">
        {creatorBullets.map((bullet) => <li>{bullet}</li>)}
      </ul>
      <aside class="micro-visual" aria-label="System visualization placeholder">
      </aside>
    </div>
  </Section>

  <Section
    id="preview"
    title="Preview"
    subtitle="A focused canvas for narrative systems, timelines, and coherence checkpoints."
  >
    <article class="preview-card">
      <div
        class="preview-frame"
        role="img"
        aria-label="Product preview placeholder"
      >
      </div>
      <p>
        This placeholder represents the upcoming product interface preview.
        Replace it with a real screenshot or interactive demo as soon as assets
        are available.
      </p>
      <div class="hero-actions" aria-label="Preview actions">
        <a
          class="button button-primary"
          href="/imprint"
          data-track="cta_preview_access">Get early access</a
        >
        <a class="button" href="/#why-toyb" data-track="cta_preview_learn"
          >See how it works</a
        >
      </div>
    </article>
  </Section>

  <script>
    import { track } from "../lib/analytics";

    const form = document.querySelector("[data-waitlist-form]");
    const feedback = document.querySelector("[data-waitlist-feedback]");

    if (form instanceof HTMLFormElement && feedback instanceof HTMLElement) {
      form.addEventListener("submit", (event) => {
        event.preventDefault();

        const emailField = form.elements.namedItem("email");
        const companyField = form.elements.namedItem("company");
        const agePrivacyField =
          form.elements.namedItem("age_privacy_confirmed");
        const marketingConsentField =
          form.elements.namedItem("marketing_consent");
        const turnstileField = form.querySelector(
          'input[name="cf-turnstile-response"]',
        );
        const submitButton = form.querySelector('button[type="submit"]');
        if (!(emailField instanceof HTMLInputElement)) return;
        if (!(companyField instanceof HTMLInputElement)) return;
        if (!(agePrivacyField instanceof HTMLInputElement)) return;
        if (!(marketingConsentField instanceof HTMLInputElement)) return;
        if (!(submitButton instanceof HTMLButtonElement)) return;
        const turnstileToken =
          turnstileField instanceof HTMLInputElement
            ? turnstileField.value.trim()
            : "";

        if (!emailField.checkValidity()) {
          emailField.reportValidity();
          return;
        }
        if (!agePrivacyField.checked) {
          feedback.textContent =
            "Please confirm you are at least 16 and accept the Privacy Policy.";
          agePrivacyField.reportValidity();
          return;
        }

        const email = emailField.value.trim();
        if (!email) return;
        const privacyVersion = form.dataset.privacyVersion ?? "";

        feedback.textContent = "";
        submitButton.disabled = true;

        fetch("/api/waitlist", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            email,
            source: "landing",
            company: companyField.value.trim(),
            turnstileToken,
            age_confirmed: agePrivacyField.checked,
            privacy_accepted: agePrivacyField.checked,
            marketing_consent: marketingConsentField.checked,
            privacy_version: privacyVersion,
          }),
        })
          .then(async (response) => {
            const result = (await response.json().catch(() => null)) as {
              status: "ok" | "error" | "forbidden";
              email?: string;
              inserted?: boolean;
              updated?: boolean;
              email_sent?: boolean;
              email_error_code?: string;
              code?: string;
            } | null;
            if (!response.ok || !result) {
              throw new Error(result?.code ?? `waitlist_${response.status}`);
            }
            return result as {
              status: "ok";
              inserted: boolean;
              updated: boolean;
              email_sent: boolean;
              email_error_code?: string;
            };
          })
          .then((result) => {
            if (result.status !== "ok") {
              throw new Error("waitlist_unknown");
            }

            if (result.email_sent) {
              feedback.textContent = "You're on the list. Check your inbox.";
            } else {
              feedback.textContent =
                "You're on the list, but we could not send the email. Retry in a moment or contact support.";
            }

            track("waitlist_submit", {
              inserted: result.inserted,
              updated: result.updated,
              email_sent: result.email_sent,
              email_error_code: result.email_error_code ?? "none",
              path: window.location.pathname,
            });
            form.reset();
          })
          .catch((error) => {
            const message =
              error instanceof Error ? error.message : "unknown_error";
            if (message === "forbidden_origin") {
              feedback.textContent =
                "This origin is not allowed for submissions.";
              return;
            }
            if (message === "invalid_request") {
              feedback.textContent = "Please check the email and try again.";
              return;
            }
            if (message === "age_required") {
              feedback.textContent =
                "Please confirm you are at least 16 years old.";
              return;
            }
            if (message === "privacy_required") {
              feedback.textContent =
                "Please accept the Privacy Policy to continue.";
              return;
            }
            if (message === "rate_limited") {
              feedback.textContent = "Too many attempts. Try again later.";
              return;
            }
            if (message === "server_error") {
              feedback.textContent =
                "Service is temporarily unavailable. Try again shortly.";
              return;
            }
            feedback.textContent = "Something went wrong. Try again.";
          })
          .finally(() => {
            submitButton.disabled = false;
          });
      });
    }
  </script>
  {
    waitlistTurnstileEnabled && (
      <script
        src="https://challenges.cloudflare.com/turnstile/v0/api.js"
        async
        defer
      />
    )
  }
</BaseLayout>
